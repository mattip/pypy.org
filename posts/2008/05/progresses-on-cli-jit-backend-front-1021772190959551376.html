<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Progresses on the CLI JIT backend front | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2008/05/progresses-on-cli-jit-backend-front-1021772190959551376.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<meta name="author" content="The PyPy Team">
<link rel="prev" href="more-windows-support-1747028151130099034.html" title="More windows support" type="text/html">
<link rel="next" href="threads-and-gcs-1126087726480790112.html" title="Threads and GCs" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Progresses on the CLI JIT backend front">
<meta property="og:url" content="https://www.pypy.org/posts/2008/05/progresses-on-cli-jit-backend-front-1021772190959551376.html">
<meta property="og:description" content="In the last months, I've actively worked on the CLI backend for PyPy's
JIT generator, whose goal is to automatically generate JIT compilers
that produces .NET bytecode on the fly.
The CLI JIT backend ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2008-05-28T14:10:00Z">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog">Index</a> </li>  
                    <li> <a href="../../../categories">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://twitter.com/pypyproject">Twitter</a> </li>  
                    <li> <a href="https://quodlibet.duckdns.org/irc/pypy/latest.log.html#irc-end">IRC</a> </li>  
                    <li> <a href="../../../people.html">People</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section></header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Progresses on the CLI JIT backend front</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    The PyPy Team
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2008-05-28T14:10:00Z" itemprop="datePublished" title="2008-05-28 14:10">2008-05-28 14:10</time></a>
            </p>
            <p class="commentline">  3 comments
</p>
                <p class="commentline">                <a href="progresses-on-cli-jit-backend-front-1021772190959551376.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>In the last months, I've actively worked on the CLI backend for PyPy's
JIT generator, whose goal is to automatically generate JIT compilers
that produces .NET bytecode on the fly.</p>
<p>The CLI JIT backend is far from be completed and there is still a lot
of work to be done before it can handle the full PyPy's Python
interpreter; nevertheless, yesterday I finally got the first .NET
executable that contains a JIT for a very simple toy language called
<a class="reference" href="https://codespeak.net/svn/pypy/dist/pypy/jit/tl/tlr.py">tlr</a>, which implements an interpreter for a minimal register based
virtual machine with only 8 operations.</p>
<p>To compile the tlr VM, follow these steps:</p>
<blockquote>
<ol class="arabic">
<li>
<p class="first">get a fresh checkout of the <a class="reference" href="https://codespeak.net/svn/pypy/branch/oo-jit/">oo-jit branch</a>, i.e. the branch
where the CLI JIT development goes on:</p>
<pre class="literal-block">
$ svn co https://codespeak.net/svn/pypy/branch/oo-jit
</pre>
</li>
<li>
<p class="first">go to the <tt class="docutils literal"><span class="pre">oo-jit/pypy/jit/tl</span> <span class="pre">directory</span></tt>, and compile the tlr VM
with the CLI backend and JIT enabled:</p>
<pre class="literal-block">
$ cd oo-jit/pypy/jit/tl/
$ ../../translator/goal/translate.py -b cli --jit --batch targettlr
</pre>
</li>
</ol>
</blockquote>
<p>The goal of our test program is to compute the square of a given
number; since the only operations supported by the VM are addition and
negation, we compute the result by doing repetitive additions; I won't
describe the exact meaning of all the tlr bytecodes here, as they are
quite self-documenting:</p>
<pre class="literal-block">
ALLOCATE,    3,   # make space for three registers
MOV_A_R,     0,   # i = a
MOV_A_R,     1,   # copy of 'a'

SET_A,       0,
MOV_A_R,     2,   # res = 0

# 10:
SET_A,       1,
NEG_A,
ADD_R_TO_A,  0,
MOV_A_R,     0,   # i--

MOV_R_A,     2,
ADD_R_TO_A,  1,
MOV_A_R,     2,   # res += a

MOV_R_A,     0,
JUMP_IF_A,  10,   # if i!=0: goto 10

MOV_R_A,     2,
RETURN_A          # return res
</pre>
<p>You can find the program also at the end of the <a class="reference" href="https://codespeak.net/svn/pypy/dist/pypy/jit/tl/tlr.py">tlr</a> module; to get an
assembled version of the bytecode, ready to be interpreted, run this
command:</p>
<pre class="literal-block">
$ python tlr.py assemble &gt; square.tlr
</pre>
<p>Now, we are ready to execute the code through the tlr VM; if you are
using Linux/Mono, you can simply execute the <tt class="docutils literal"><span class="pre">targettlr-cli</span></tt> script
that has been created for you; however, if you use Windows, you have
to manually fish the executable inside the <tt class="docutils literal"><span class="pre">targettlr-cli-data</span></tt>
directory:</p>
<pre class="literal-block">
# Linux
$ ./targettlr-cli square.tlr 16
256

# Windows
&gt; targettlr-cli-data\main.exe square.tlr 16
256
</pre>
<p>Cool, our program computed the result correctly! But, how can we be
sure that it really JIT compiled our code instead of interpreting it?
To inspect the code that it's generated by our JIT compiler, we simply
set the <tt class="docutils literal"><span class="pre">PYPYJITLOG</span></tt> environment variable to a filename, so that the
JIT will create a .NET assembly containing all the code that has been
generated by the JIT:</p>
<pre class="literal-block">
$ PYPYJITLOG=generated.dll ./targettlr-cli square.tlr 16
256
$ file generated.dll
generated.dll: MS-DOS executable PE  for MS Windows (DLL) (console) Intel 80386 32-bit
</pre>
<p>Now, we can inspect the DLL with any IL disassembler, such as
<tt class="docutils literal"><span class="pre">ilasm</span></tt> or <tt class="docutils literal"><span class="pre">monodis</span></tt>; here is an excerpt of the disassembled code,
that shows how our <tt class="docutils literal"><span class="pre">square.tlr</span></tt> bytecode has been compiled to .NET
bytecode:</p>
<pre class="literal-block">
.method public static  hidebysig default int32 invoke (object[] A_0, int32 A_1)  cil managed
{
    .maxstack 3
    .locals init (int32 V_0, int32 V_1, int32 V_2, int32 V_3, int32 V_4, int32 V_5)

    ldc.i4 -1
    ldarg.1
    add
    stloc.1
    ldc.i4 0
    ldarg.1
    add
    stloc.2
    IL_0010:  ldloc.1
    ldc.i4.0
    cgt.un
    stloc.3
    ldloc.3
    brfalse IL_003b

    ldc.i4 -1
    ldloc.1
    add
    stloc.s 4
    ldloc.2
    ldarg.1
    add
    stloc.s 5
    ldloc.s 5
    stloc.2
    ldloc.s 4
    stloc.1
    ldarg.1
    starg 1

    nop
    nop
    br IL_0010

    IL_003b:  ldloc.2
    stloc.0
    br IL_0042

    ldloc.0
    ret
}
</pre>
<p>If you know a bit IL, you can see that the code generated is not
optimal, as there are some redundant operations like all those
stloc/ldloc pairs; however, while not optimal, it is still quite good
code, not much different to what you would get by writing the square
algorithm directly in e.g. C#.</p>
<p>As I said before, all of this is still work in progress and there is
still much to be done. Stay tuned :-).</p>
      </div>
      <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="more-windows-support-1747028151130099034.html" rel="prev" title="More windows support">Previous post</a>
            </li>
            <li class="next">
                <a href="threads-and-gcs-1126087726480790112.html" rel="next" title="Threads and GCs">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-3714354903875274716">
        <div class="comment-header">
          <a name="comment-3714354903875274716"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2008-05-28 20:11</span>:
        </div>
        <div class="comment-content">
          <p>So the mono JIT would pick up that bytecode and further compile it to native code?<br><br>Also, what would be needed for doing the same thing for the JVM?</p>
        </div>
      </div>
      <div class="comment comment-1842535854740215356">
        <div class="comment-header">
          <a name="comment-1842535854740215356"></a>
            <span class="author">Antonio Cuni</span> wrote on <span class="date">2008-05-28 21:28</span>:
        </div>
        <div class="comment-content">
          <p>Yes, that's exactly the idea; in fact, the program run by virtual machines generated this way are double jit-ed.<br><br>Doing the same for the JVM won't be too hard, since most of the work we've done can be shared between the two JIT backends; unfortunately, at the moment the JVM backend is not as advanced as the CLI one, so before working on the JIT we would need more work on it.  But indeed, having a JIT backend for the JVM is in our plans.</p>
        </div>
      </div>
      <div class="comment comment-8471780964306442017">
        <div class="comment-header">
          <a name="comment-8471780964306442017"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2008-05-29 10:13</span>:
        </div>
        <div class="comment-content">
          <p>Great. Can't wait for advanced piggybacking :)</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2020/12/mac-meets-arm64-940822335619099039.html" class="listtitle">Mac meets Arm64</a>
      </li>
      <li>
        <a href="/posts/2020/11/pypy-733-triple-release-python-37-36-3446596804408262749.html" class="listtitle">PyPy 7.3.3 triple release: python 3.7, 3.6, and 2.7</a>
      </li>
      <li>
        <a href="/posts/2020/09/pypy-732-triple-release-python-27-36-3980901335490872787.html" class="listtitle">PyPy 7.3.2 triple release: python 2.7, 3.6, and 3.7</a>
      </li>
      <li>
        <a href="/posts/2020/08/pypy-is-on-open-collective-5673322428814364737.html" class="listtitle">PyPy is on Open Collective</a>
      </li>
      <li>
        <a href="/posts/2020/08/a-new-chapter-for-pypy-8388322709667328389.html" class="listtitle">A new chapter for PyPy</a>
      </li>
      <li>
        <a href="/posts/2020/04/pypy-731-released-6266451647387657480.html" class="listtitle">PyPy 7.3.1 released</a>
      </li>
      <li>
        <a href="/posts/2020/03/leysin-2020-sprint-report-764567777353955897.html" class="listtitle">Leysin 2020 Sprint Report</a>
      </li>
      <li>
        <a href="/posts/2020/02/pypy-and-cffi-have-moved-to-heptapod-5791595152472747032.html" class="listtitle">PyPy and CFFI have moved to Heptapod</a>
      </li>
      <li>
        <a href="/posts/2020/01/leysin-winter-sprint-2020-feb-28-march-6349761524797409012.html" class="listtitle">Leysin Winter sprint 2020: Feb 29 - March 8th</a>
      </li>
      <li>
        <a href="/posts/2019/12/pypy-730-released-3614026620096963655.html" class="listtitle">PyPy 7.3.0 released</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (1)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (3)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (2)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (18)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (1)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (47)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releasepypy.html">releasepypy</a> (1)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (3)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div>
    <img src="../../../images/pypy-logo-nav-grey.png" alt="PyPy Logo">
</div>
  <div class="logotext">
     Contents © 2021 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
    Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a> 
  </div>
  <div style="margin-left: auto">
  <a href="rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>
