<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Software Transactional Memory lisp experiments | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2013/07/software-transactional-memory-lisp-7777576128992250197.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<meta name="author" content="The PyPy Team">
<link rel="prev" href="pypy-21-beta-1351105697755187196.html" title="PyPy 2.1 beta" type="text/html">
<link rel="next" href="pypy-london-sprint-august-26-september-5156945690440578388.html" title="PyPy London Sprint (August 26 - September 1 2013)" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Software Transactional Memory lisp experiments">
<meta property="og:url" content="https://www.pypy.org/posts/2013/07/software-transactional-memory-lisp-7777576128992250197.html">
<meta property="og:description" content="As covered in the previous blog post, the STM subproject of PyPy has been
back on the drawing board. The result of this experiment is an STM-aware
garbage collector written in C. This is finished by n">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-07-12T10:07:00Z">
<meta property="article:tag" content="stm">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog">Index</a> </li>  
                    <li> <a href="../../../categories">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://twitter.com/pypyproject">Twitter</a> </li>  
                    <li> <a href="https://quodlibet.duckdns.org/irc/pypy/latest.log.html#irc-end">IRC</a> </li>  
                    <li> <a href="../../../people.html">People</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section></header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Software Transactional Memory lisp experiments</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    The PyPy Team
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2013-07-12T10:07:00Z" itemprop="datePublished" title="2013-07-12 10:07">2013-07-12 10:07</time></a>
            </p>
            <p class="commentline">  7 comments
</p>
                <p class="commentline">                <a href="software-transactional-memory-lisp-7777576128992250197.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <div dir="ltr" style="text-align: left;">
<p>As covered in <a class="reference external" href="https://morepypy.blogspot.com/2013/06/stm-on-drawing-board.html">the previous blog post</a>, the STM subproject of PyPy has been
back on the drawing board. The result of this experiment is an STM-aware
garbage collector written in C. This is finished by now, thanks to Armin's
and Remi's work, we have a fully functional garbage collector and a STM system
that can be used from any C program with enough effort. Using it is more than
a little mundane, since you have to inserts write and read barriers by hand
everywhere in your code that reads or writes to garbage collector controlled
memory. In the PyPy integration, this manual work is done automatically
by the STM transformation in the interpreter.</p>
<p>However, to experiment some more, we created a minimal
<a class="reference external" href="https://bitbucket.org/arigo/duhton">lisp-like/scheme-like interpreter</a>
(called Duhton), that follows closely CPython's implementation strategy.
For anyone familiar with CPython's source code, it should be pretty
readable. This interpreter works like a normal and very basic lisp variant,
however it comes with a <tt class="docutils literal">transaction</tt> builtin, that lets you spawn transactions
using the STM system. We implemented a few demos that let you play with the
transaction system. All the demos are running without conflicts, which means
there are no conflicting writes to global memory and hence the demos are very
amenable to parallelization. They exercise:</p>
<ul class="simple">
<li>arithmetics - <tt class="docutils literal">demo/many_sqare_roots.duh</tt>
</li>
<li>read-only access to globals - <tt class="docutils literal">demo/trees.duh</tt>
</li>
<li>read-write access to local objects - <tt class="docutils literal">demo/trees2.duh</tt>
</li>
</ul>
<p>With the latter ones being very similar to the classic gcbench. STM-aware
Duhton can be found in <a class="reference external" href="https://bitbucket.org/pypy/stmgc">the stmgc repo</a>, while the STM-less Duhton,
that uses refcounting, can be found in <a class="reference external" href="https://bitbucket.org/arigo/duhton">the duhton repo</a> under the <tt class="docutils literal">base</tt>
branch.</p>
<p>Below are some benchmarks. Note that this is a little comparing apples to
oranges since the single-threaded duhton uses refcounting GC vs generational
GC for STM version. Future pypy benchmarks will compare more apples to apples.
Moreover none of the benchmarks has any conflicts. Time is the total time
that the benchmark took (not the CPU time) and there was very little variation
in the consecutive runs (definitely below 5%).</p>
<table border="1" class="docutils">
<colgroup>
<col width="16%">
<col width="30%">
<col width="23%">
<col width="16%">
<col width="16%">
</colgroup>
<tbody valign="top">
<tr>
<td>benchmark</td>
<td>1 thread (refcount)</td>
<td>1 thread (stm)</td>
<td>2 threads</td>
<td>4 threads</td>
</tr>
<tr>
<td>square</td>
<td>1.9s</td>
<td>3.5s</td>
<td>1.8s</td>
<td>0.9s</td>
</tr>
<tr>
<td>trees</td>
<td>0.6s</td>
<td>1.0s</td>
<td>0.54s</td>
<td>0.28s</td>
</tr>
<tr>
<td>trees2</td>
<td>1.4s</td>
<td>2.2s</td>
<td>1.1s</td>
<td>0.57s</td>
</tr>
</tbody>
</table>
<p>As you can see, the slowdown for STM vs single thread is significant
(1.8x, 1.7x, 1.6x respectively), but still lower than 2x. However the speedup
from running on multiple threads parallelizes the problem almost perfectly.</p>
<p>While a significant milestone, we hope the next blog post will cover
STM-enabled pypy that's fully working with JIT work ongoing.</p>
<p>Cheers,<br>
fijal on behalf of Remi Meier and Armin Rigo</p>
<br><br>
</div>
      </div>
      <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/stm.html" rel="tag">stm</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="pypy-21-beta-1351105697755187196.html" rel="prev" title="PyPy 2.1 beta">Previous post</a>
            </li>
            <li class="next">
                <a href="pypy-london-sprint-august-26-september-5156945690440578388.html" rel="next" title="PyPy London Sprint (August 26 - September 1 2013)">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-7303404958617814481">
        <div class="comment-header">
          <a name="comment-7303404958617814481"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-07-12 13:06</span>:
        </div>
        <div class="comment-content">
          <p>I hacked a bit; inserted likely hint on early exit on spinlock acquisition, Haswell xacquire/xrelease hints on spinlock acquisition and release, and compiled with Haswell optimized flags.<br><br>Resulting scaling from 1 to 4 threads for tests were 1.92, 1.87 and 1.88. I think that's already quite close to 2.<br><br>I think this is OK, but not extraordinary.</p>
        </div>
      </div>
      <div class="comment comment-4444189776829350929">
        <div class="comment-header">
          <a name="comment-4444189776829350929"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-07-12 13:12</span>:
        </div>
        <div class="comment-content">
          <p>Just to clarify my above comment: those were average factors of scaling per doubling of threads. So, 4-thread version ran actually 3.67, 3.50 and 3.54 times faster than single-threaded version.</p>
        </div>
      </div>
      <div class="comment comment-9024292149812054183">
        <div class="comment-header">
          <a name="comment-9024292149812054183"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2013-07-12 13:15</span>:
        </div>
        <div class="comment-content">
          <p>Cool that you hacked on it!  Note however that spinlock acquisition is not a blocker in these examples --- we implement STM mostly without locks, and locks are acquired rarely.  Running independent code without getting STM conflicts means that each thread will in practice only acquire its own lock.  And a single global lock is used for major GC --- but there, the large amount of work done means that using the Haswell xacquire/xrelease hints is just counterproductive.<br><br>"Resulting scaling from 1 to 4 threads" doesn't mean anything, as in some examples it scales perfectly, and in other examples it doesn't scale at all (as expected).</p>
        </div>
      </div>
      <div class="comment comment-619252368933687858">
        <div class="comment-header">
          <a name="comment-619252368933687858"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-07-12 13:39</span>:
        </div>
        <div class="comment-content">
          <p>All your arguments are valid, and I didn't really expect much from hinting, just decided to try. It would seem that Haswell is still inching towards higher multicore scalability - probably thanks to improved atomic and fence ops in general. It's a benefit for those workloads that should conceptually scale well...</p>
        </div>
      </div>
      <div class="comment comment-2740970907269201992">
        <div class="comment-header">
          <a name="comment-2740970907269201992"></a>
            <span class="author">Glen Newton</span> wrote on <span class="date">2013-07-13 18:19</span>:
        </div>
        <div class="comment-content">
          <p>You really need to go above 4 threads: 8,16,32, and 64 at least. Then plot out the overhead of the STM related to this level of threading. If your benchmark is too small, alter it so that it makes sense to try and solve it with 64 threads.</p>
        </div>
      </div>
      <div class="comment comment-6455731373660603980">
        <div class="comment-header">
          <a name="comment-6455731373660603980"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2013-07-14 06:31</span>:
        </div>
        <div class="comment-content">
          <p>@glen: we're focusing right now on the machines we have, which are standard Intels with 4, 8, or at most 12 cores.  I believe it is interesting too, and it's what people have right now in their own desktop or laptop computers.  Obviously the scalability to larger numbers of cores is important as well, but we can't simply disregard any result involving less than 64 cores.</p>
        </div>
      </div>
      <div class="comment comment-44534362025771065">
        <div class="comment-header">
          <a name="comment-44534362025771065"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-07-17 17:20</span>:
        </div>
        <div class="comment-content">
          <p>This is a really great news.<br><br>Wish you all the best with further work!</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2020/12/mac-meets-arm64-940822335619099039.html" class="listtitle">Mac meets Arm64</a>
      </li>
      <li>
        <a href="/posts/2020/11/pypy-733-triple-release-python-37-36-3446596804408262749.html" class="listtitle">PyPy 7.3.3 triple release: python 3.7, 3.6, and 2.7</a>
      </li>
      <li>
        <a href="/posts/2020/09/pypy-732-triple-release-python-27-36-3980901335490872787.html" class="listtitle">PyPy 7.3.2 triple release: python 2.7, 3.6, and 3.7</a>
      </li>
      <li>
        <a href="/posts/2020/08/pypy-is-on-open-collective-5673322428814364737.html" class="listtitle">PyPy is on Open Collective</a>
      </li>
      <li>
        <a href="/posts/2020/08/a-new-chapter-for-pypy-8388322709667328389.html" class="listtitle">A new chapter for PyPy</a>
      </li>
      <li>
        <a href="/posts/2020/04/pypy-731-released-6266451647387657480.html" class="listtitle">PyPy 7.3.1 released</a>
      </li>
      <li>
        <a href="/posts/2020/03/leysin-2020-sprint-report-764567777353955897.html" class="listtitle">Leysin 2020 Sprint Report</a>
      </li>
      <li>
        <a href="/posts/2020/02/pypy-and-cffi-have-moved-to-heptapod-5791595152472747032.html" class="listtitle">PyPy and CFFI have moved to Heptapod</a>
      </li>
      <li>
        <a href="/posts/2020/01/leysin-winter-sprint-2020-feb-28-march-6349761524797409012.html" class="listtitle">Leysin Winter sprint 2020: Feb 29 - March 8th</a>
      </li>
      <li>
        <a href="/posts/2019/12/pypy-730-released-3614026620096963655.html" class="listtitle">PyPy 7.3.0 released</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (1)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (3)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (2)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (18)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (1)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (47)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releasepypy.html">releasepypy</a> (1)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (3)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div>
    <img src="../../../images/pypy-logo-nav-grey.png" alt="PyPy Logo">
</div>
  <div class="logotext">
     Contents © 2021 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
    Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a> 
  </div>
  <div style="margin-left: auto">
  <a href="rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>
