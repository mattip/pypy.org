<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Making coverage.py faster under PyPy | PyPy</title>
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_rst.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/styles.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://www.pypy.org/posts/2013/10/making-coveragepy-faster-under-pypy-935409618297062344.html">
<link rel="icon" href="../../../favicon2.ico" sizes="16x16">
<link rel="icon" href="../../../favicon32x32.ico" sizes="32x32">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<meta name="author" content="The PyPy Team">
<link rel="prev" href="update-on-stm-7145890443443707910.html" title="Update on STM" type="text/html">
<link rel="next" href="../11/py3k-status-update-12-5307085693947812769.html" title="Py3k status update #12" type="text/html">
<meta property="og:site_name" content="PyPy">
<meta property="og:title" content="Making coverage.py faster under PyPy">
<meta property="og:url" content="https://www.pypy.org/posts/2013/10/making-coveragepy-faster-under-pypy-935409618297062344.html">
<meta property="og:description" content="If you've ever tried to run your programs with coverage.py under PyPy,
you've probably experienced some incredible slowness. Take this simple
program:def f():
    return 1


def main():
    i = 100000">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-10-26T00:48:00Z">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container">
             <header id="header"><!-- Adapted from https://www.taniarascia.com/responsive-dropdown-navigation-bar --><section class="navigation"><div class="nav-container">
            <div class="brand">
                <a href="../../../index.html">
                    <image id="toplogo" src="../../../images/pypy-logo.svg" width="75px;" alt="PyPy/"></image></a>
            </div>
            <nav><ul class="nav-list">
<li> 
                <a href="#!">Features</a>
                <ul class="nav-dropdown">
<li> <a href="../../../features.html">What is PyPy?</a> </li>  
                    <li> <a href="../../../compat.html">Compatibility</a> </li>  
                    <li> <a href="../../../performance.html">Performance</a> </li>  
                </ul>
</li>
          <li> <a href="../../../download.html">Download</a> </li>  
          <li> <a href="http://doc.pypy.org">Dev Docs</a> </li>  
            <li> 
                <a href="#!">Blog</a>
                <ul class="nav-dropdown">
<li> <a href="../../../blog">Index</a> </li>  
                    <li> <a href="../../../categories">Tags</a> </li>  
                    <li> <a href="../../../archive.html">Archive by year</a> </li>  
                    <li> <a href="../../../rss.xml">RSS feed</a> </li>  
                    <li> <a href="https://morepypy.blogspot.com/">Old site</a> </li>  
                </ul>
</li>
            <li> 
                <a href="#!">About</a>
                <ul class="nav-dropdown">
<li> <a href="https://twitter.com/pypyproject">Twitter</a> </li>  
                    <li> <a href="https://quodlibet.duckdns.org/irc/pypy/latest.log.html#irc-end">IRC</a> </li>  
                    <li> <a href="../../../people.html">People</a> </li>  
                    <li> <a href="../../../howtohelp.html">How To Help?</a> </li>  
                    <li> <a href="../../../contact.html">Contact</a> </li>  
                </ul>
</li>

                </ul></nav><div class="nav-mobile">
                <a id="nav-toggle" href="#!"> <span></span></a>
            </div>
        </div>
    </section></header><main id="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="post">
          <header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Making coverage.py faster under PyPy</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    The PyPy Team
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2013-10-26T00:48:00Z" itemprop="datePublished" title="2013-10-26 00:48">2013-10-26 00:48</time></a>
            </p>
            <p class="commentline">  5 comments
</p>
                <p class="commentline">                <a href="making-coveragepy-faster-under-pypy-935409618297062344.html#utterances-thread">Comments</a>


            
        </p>
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
      <p>If you've ever tried to run your programs with <tt class="docutils literal">coverage.py</tt> under PyPy,<br>
you've probably experienced some incredible slowness. Take this simple<br>
program:</p>
<pre class="code python literal-block"><span class="keyword">def</span> <span class="name function">f</span><span class="punctuation">():</span>
    <span class="keyword">return</span> <span class="literal number integer">1</span>


<span class="keyword">def</span> <span class="name function">main</span><span class="punctuation">():</span>
    <span class="name">i</span> <span class="operator">=</span> <span class="literal number integer">10000000</span>
    <span class="keyword">while</span> <span class="name">i</span><span class="punctuation">:</span>
        <span class="name">i</span> <span class="operator">-=</span> <span class="name">f</span><span class="punctuation">()</span>

<span class="name">main</span><span class="punctuation">()</span>
</pre>
<p>Running <tt class="docutils literal">time coverage.py run test.py</tt> five times, and looking at the best<br>
run, here's how PyPy 2.1 stacks up against CPython 2.7.5:</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%">
<col width="19%">
<col width="49%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Python</th>
<th class="head">Time</th>
<th class="head">Normalized to CPython</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>CPython 2.7.5</td>
<td>3.879s</td>
<td>1.0x</td>
</tr>
<tr>
<td>PyPy 2.1</td>
<td>53.330s</td>
<td>13.7x slower</td>
</tr>
</tbody>
</table>
<p>Totally ridiculous. I got turned onto this problem because on one of my<br>
projects CPython takes about 1.5 minutes to run our test suite on the build<br>
bot, but PyPy takes 8-10 minutes.</p>
<p>So I sat down to address it. And the results:</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%">
<col width="19%">
<col width="49%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Python</th>
<th class="head">Time</th>
<th class="head">Normalized to CPython</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>CPython 2.7.5</td>
<td>3.879s</td>
<td>1.0x</td>
</tr>
<tr>
<td>PyPy 2.1</td>
<td>53.330s</td>
<td>13.7x slower</td>
</tr>
<tr>
<td>PyPy head</td>
<td>1.433s</td>
<td>2.7x faster</td>
</tr>
</tbody>
</table>
<p>Not bad.</p>
<div class="section" id="technical-details">
<h1>Technical details</h1>
<p>So how'd we do it? Previously, using <tt class="docutils literal">sys.settrace()</tt> (which <tt class="docutils literal">coverage.py</tt><br>
uses under the hood) disabled the JIT. Except it didn't just disable the JIT,<br>
it did it in a particularly insidious way — the JIT had no idea it was being<br>
disabled!</p>
<p>Instead, every time PyPy discovered that one of your functions was a hotspot,<br>
it would start tracing to observe what the program was doing, and right when it<br>
was about to finish, <tt class="docutils literal">coverage</tt> would run and cause the JIT to abort. Tracing<br>
is a slow process, it makes up for it by generating fast machine code at the<br>
end, but tracing is still incredibly slow. But we never actually got to the<br>
"generate fast machine code" stage. Instead we'd pay all the cost of tracing,<br>
but then we'd abort, and reap none of the benefits.</p>
<p>To fix this, we adjusted some of the heuristics in the JIT, to better show it<br>
how <tt class="docutils literal"><span class="pre">sys.settrace(&lt;tracefunc&gt;)</span></tt> works. Previously the JIT saw it as an opaque<br>
function which gets the frame object, and couldn't tell whether or not it<br>
messed with the frame object. Now we let the JIT look inside the<br><tt class="docutils literal">&lt;tracefunc&gt;</tt> function, so it's able to see that <tt class="docutils literal">coverage.py</tt> isn't<br>
messing with the frame in any weird ways, it's just reading the line number and<br>
file path out of it.</p>
<p>I asked several friends in the VM implementation and research field if they<br>
were aware of any other research into making VMs stay fast when debugging tools<br>
like <tt class="docutils literal">coverage.py</tt> are running. No one I spoke to was aware of any (but I<br>
didn't do a particularly exhaustive review of the literature, I just tweeted at<br>
a few people), so I'm pleased to say that PyPy is quite possibly the first VM<br>
to work on optimizing code in debugging mode! This is possible because of our<br>
years spent investing in meta-tracing research.</p>
</div>
<p>Happy testing,<br>
Alex</p>
      </div>
      <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="update-on-stm-7145890443443707910.html" rel="prev" title="Update on STM">Previous post</a>
            </li>
            <li class="next">
                <a href="../11/py3k-status-update-12-5307085693947812769.html" rel="next" title="Py3k status update #12">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                <div class="comment-level comment-level-1">
      <div class="comment comment-7519221966276194932">
        <div class="comment-header">
          <a name="comment-7519221966276194932"></a>
            <span class="author">John Doe</span> wrote on <span class="date">2013-10-26 20:40</span>:
        </div>
        <div class="comment-content">
          <p>No, you're not the first to make this pretentious mistake.<br><br>What's the report for code that was actually eliminated by optimizations? Was it covered? Was it not?</p>
        </div>
      </div>
      <div class="comment comment-2643323908086188088">
        <div class="comment-header">
          <a name="comment-2643323908086188088"></a>
            <span class="author">Anonymous</span> wrote on <span class="date">2013-10-27 17:53</span>:
        </div>
        <div class="comment-content">
          <p>You misunderstand John Doe.  The coverage report is for the user's Python code, which isn't optimized, eliminated, or otherwise modified.  The PyPy speedups come from a clever reimplementation of the interpreter that runs the user's Python code, and this article was explaining how they found and fixed a big slowdown that happens to be triggered by a common test-related library.</p>
        </div>
      </div>
      <div class="comment comment-8025009020854068964">
        <div class="comment-header">
          <a name="comment-8025009020854068964"></a>
            <span class="author">Armin Rigo</span> wrote on <span class="date">2013-10-27 19:37</span>:
        </div>
        <div class="comment-content">
          <p>@John Doe: sadly, we fail to understand exactly what part of the blog post you're answering to in your sentence "No, you're not the first to make this pretentious mistake".  Can you please give more context and elaborate a bit?</p>
        </div>
      </div>
      <div class="comment comment-749813283935744890">
        <div class="comment-header">
          <a name="comment-749813283935744890"></a>
            <span class="author">John M. Camara</span> wrote on <span class="date">2013-10-27 21:09</span>:
        </div>
        <div class="comment-content">
          <p>@Armin: I believe John Doe is talking about the last paragraph as I believe the JVM also does not disable optimizations when using debug tools.<br><br>If this is the case than his comment is silly as Alex clearly stated he didn't do an exhaustive search.</p>
        </div>
      </div>
      <div class="comment comment-7651274891160099053">
        <div class="comment-header">
          <a name="comment-7651274891160099053"></a>
            <span class="author">Unknown</span> wrote on <span class="date">2013-10-30 07:17</span>:
        </div>
        <div class="comment-content">
          <p>This sounds similar to the -Og setting of GCC, which enables all optimizations which do not interfere with debugging.</p>
        </div>
      </div>
         </div>

          </section>
</div>
    <div class="sidebar">
<div>
  <h2>
    The PyPy blogposts
  </h2>
  <div>
    Create a guest post via a PR to the <a href="https://github.com/pypy/pypy.org">source repo</a>
  </div>
</div>
    <div id="global-recent-posts">
    <h2>
      Recent Posts
    </h2>
    <ul class="post-list">
      <li>
        <a href="/posts/2020/12/mac-meets-arm64-940822335619099039.html" class="listtitle">Mac meets Arm64</a>
      </li>
      <li>
        <a href="/posts/2020/11/pypy-733-triple-release-python-37-36-3446596804408262749.html" class="listtitle">PyPy 7.3.3 triple release: python 3.7, 3.6, and 2.7</a>
      </li>
      <li>
        <a href="/posts/2020/09/pypy-732-triple-release-python-27-36-3980901335490872787.html" class="listtitle">PyPy 7.3.2 triple release: python 2.7, 3.6, and 3.7</a>
      </li>
      <li>
        <a href="/posts/2020/08/pypy-is-on-open-collective-5673322428814364737.html" class="listtitle">PyPy is on Open Collective</a>
      </li>
      <li>
        <a href="/posts/2020/08/a-new-chapter-for-pypy-8388322709667328389.html" class="listtitle">A new chapter for PyPy</a>
      </li>
      <li>
        <a href="/posts/2020/04/pypy-731-released-6266451647387657480.html" class="listtitle">PyPy 7.3.1 released</a>
      </li>
      <li>
        <a href="/posts/2020/03/leysin-2020-sprint-report-764567777353955897.html" class="listtitle">Leysin 2020 Sprint Report</a>
      </li>
      <li>
        <a href="/posts/2020/02/pypy-and-cffi-have-moved-to-heptapod-5791595152472747032.html" class="listtitle">PyPy and CFFI have moved to Heptapod</a>
      </li>
      <li>
        <a href="/posts/2020/01/leysin-winter-sprint-2020-feb-28-march-6349761524797409012.html" class="listtitle">Leysin Winter sprint 2020: Feb 29 - March 8th</a>
      </li>
      <li>
        <a href="/posts/2019/12/pypy-730-released-3614026620096963655.html" class="listtitle">PyPy 7.3.0 released</a>
      </li>
    </ul>
  </div>

          <div id="global-archive-list">
          <h2>
            Archives
          </h2>
          <ul class="archive-level archive-level-1">
            <li><a class="reference" href="/2007/">2007</a> (19)
            </li>
            <li><a class="reference" href="/2008/">2008</a> (62)
            </li>
            <li><a class="reference" href="/2009/">2009</a> (38)
            </li>
            <li><a class="reference" href="/2010/">2010</a> (44)
            </li>
            <li><a class="reference" href="/2011/">2011</a> (43)
            </li>
            <li><a class="reference" href="/2012/">2012</a> (44)
            </li>
            <li><a class="reference" href="/2013/">2013</a> (46)
            </li>
            <li><a class="reference" href="/2014/">2014</a> (22)
            </li>
            <li><a class="reference" href="/2015/">2015</a> (20)
            </li>
            <li><a class="reference" href="/2016/">2016</a> (20)
            </li>
            <li><a class="reference" href="/2017/">2017</a> (13)
            </li>
            <li><a class="reference" href="/2018/">2018</a> (12)
            </li>
            <li><a class="reference" href="/2019/">2019</a> (12)
            </li>
            <li><a class="reference" href="/2020/">2020</a> (9)
            </li>
          </ul>
        </div>


          <div id="global-tag-list">
          <h2>
            Tags
          </h2>
          <ul>
            <li><a class="reference" href="/categories/arm.html">arm</a> (1)</li>
            <li><a class="reference" href="/categories/cli.html">cli</a> (1)</li>
            <li><a class="reference" href="/categories/compiler.html">compiler</a> (1)</li>
            <li><a class="reference" href="/categories/cpyext.html">cpyext</a> (3)</li>
            <li><a class="reference" href="/categories/cpython.html">CPython</a> (3)</li>
            <li><a class="reference" href="/categories/ep2008.html">ep2008</a> (1)</li>
            <li><a class="reference" href="/categories/extension-modules.html">extension modules</a> (2)</li>
            <li><a class="reference" href="/categories/graalpython.html">GraalPython</a> (1)</li>
            <li><a class="reference" href="/categories/hpy.html">hpy</a> (1)</li>
            <li><a class="reference" href="/categories/heptapod.html">Heptapod</a> (1)</li>
            <li><a class="reference" href="/categories/jit.html">jit</a> (18)</li>
            <li><a class="reference" href="/categories/jython.html">jython</a> (1)</li>
            <li><a class="reference" href="/categories/kcachegrind.html">kcachegrind</a> (1)</li>
            <li><a class="reference" href="/categories/numpy.html">numpy</a> (24)</li>
            <li><a class="reference" href="/categories/parser.html">parser</a> (1)</li>
            <li><a class="reference" href="/categories/profiling.html">profiling</a> (1)</li>
            <li><a class="reference" href="/categories/pypy.html">pypy</a> (6)</li>
            <li><a class="reference" href="/categories/pypy3.html">pypy3</a> (16)</li>
            <li><a class="reference" href="/categories/pyqt4.html">PyQt4</a> (1)</li>
            <li><a class="reference" href="/categories/release.html">release</a> (47)</li>
            <li><a class="reference" href="/categories/releasecffi.html">releasecffi</a> (3)</li>
            <li><a class="reference" href="/categories/releasepypy.html">releasepypy</a> (1)</li>
            <li><a class="reference" href="/categories/releaserevdb.html">releaserevdb</a> (1)</li>
            <li><a class="reference" href="/categories/releasestm.html">releasestm</a> (1)</li>
            <li><a class="reference" href="/categories/revdb.html">revdb</a> (1)</li>
            <li><a class="reference" href="/categories/roadmap.html">roadmap</a> (1)</li>
            <li><a class="reference" href="/categories/rpyc.html">RPyC</a> (1)</li>
            <li><a class="reference" href="/categories/speed.html">speed</a> (3)</li>
            <li><a class="reference" href="/categories/sprint.html">sprint</a> (3)</li>
            <li><a class="reference" href="/categories/stm.html">stm</a> (14)</li>
            <li><a class="reference" href="/categories/sun.html">sun</a> (1)</li>
            <li><a class="reference" href="/categories/smalltalk.html">Smalltalk</a> (1)</li>
            <li><a class="reference" href="/categories/squeak.html">Squeak</a> (1)</li>
            <li><a class="reference" href="/categories/unicode.html">unicode</a> (1)</li>
            <li><a class="reference" href="/categories/valgrind.html">valgrind</a> (1)</li>
          </ul>
        </div>    </div>
</article></main><footer id="footer"><p>
</p>
<div class="myfooter">
  <div>
    <img src="../../../images/pypy-logo-nav-grey.png" alt="PyPy Logo">
</div>
  <div class="logotext">
     Contents © 2021 <a href="mailto:pypy-dev@pypy.org">The PyPy Team</a>
    Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a> 
  </div>
  <div style="margin-left: auto">
  <a href="rss.xml">RSS feed</a>
</div>

            
        

    </div>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" crossorigin="anonymous"></script><script src="../../../assets/js/styles.js"></script></footer>
</div>
</body>
</html>
